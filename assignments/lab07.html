<!doctype html>
<html lang="en">
    <head>
            <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="/spring2025/assets/images/favicon.ico" type="image/x-icon">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge">
    <title>AsyncIO + MVC</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    <link rel="stylesheet" href="/spring2025/assets/main.css">
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-163192686-1"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-163192686-1');
    </script>
    </head>
    <body class="two-column">
        <!-- banner -->
<header>
    <section>
        <h1 class="desktop"><a href="/spring2025/">CSCI 338: Spring 2025</a></h1>
        <h2 class="desktop">Software Engineering</h2>
        <a class="mobile" href="#">
            <i class="menu-toggle fas fa-bars"></i>
        </a>
        <h1 class="mobile">CSCI 338: Spring 2025</h1>
    </section>
    <img src="https://communication.unca.edu/wp-content/themes/tin/assets/logo.svg" />
</header>
        <nav>
    <ul>
        <li ><a href="/spring2025/syllabus/">Syllabus</a>
        </li>
        <li ><a
                href="/spring2025/">Schedule</a></li>
        <li class="active" ><a
                href="/spring2025/assignments/">Assignments</a></li>
        <li ><a
                href="/spring2025/resources/">Resources</a></li>
        <li ><a href="/spring2025/repos/">Repos</a>
        </li>
        <li><a href="https://drive.google.com/drive/folders/1F04DqxzsbKMFNIsGkrv_FbglDk5WKRit?usp=sharing"
                target="_blank">Videos</a></li>
    </ul>
</nav>
        <main>
            <aside>
                
                
                <ol class="side-menu">
  <li><a href="#id_set-up">Set Up</a></li>
  <li><a href="#id_install-the-dependencies-run-your-webserver">Install the dependencies, run your webserver</a>
    <ol>
      <li><a href="#id_test-out-your-app">Test out your app</a></li>
      <li><a href="#id_questions-to-ask-yourself">Questions to ask yourself</a></li>
    </ol>
  </li>
  <li><a href="#id_introduction-to-mvc">Introduction to MVC</a>
    <ol>
      <li><a href="#id_models---organizing-and-fetching-data">Models - Organizing and Fetching Data</a></li>
      <li><a href="#id_example-model">Example Model:</a></li>
      <li><a href="#id_1-model-task">1. Model Task</a></li>
      <li><a href="#id_controller---managing-requests">Controller - Managing Requests</a></li>
      <li><a href="#id_2-controller-task">2. Controller Task</a></li>
      <li><a href="#id_view---displaying-data">View - Displaying Data</a></li>
      <li><a href="#id_3-view-task">3. View Task</a></li>
    </ol>
  </li>
  <li><a href="#id_extra-tasks">Extra Tasks</a>
    <ol>
      <li><a href="#id_useful-documentation">Useful documentation</a></li>
    </ol>
  </li>
  <li><a href="#id_what-to-submit">What to Submit</a></li>
</ol>

            </aside>
            <article>
                

    
    <h1>
        <a href="../assignments/">Assignments</a> >
        Lab 7: AsyncIO + MVC
    </h1>
    
 
                <p>
    
        Due on Wed, 03/26 @ 11:59PM.
    
    
        6 Points.
    
    
</p>

<h2 id="id_set-up">Set Up</h2>
<p>Before you begin, get the latest code from <a href="https://github.com/csci338/class-exercises-spring2025" target="_blank">class-exercises-spring2025</a>.</p>
<ul>
  <li>If you are a Windows user, you will do this lab (and all subsequent work in this class) using the WSL terminal.</li>
</ul>

<p><strong>On GitHub:</strong></p>
<ul>
  <li>Sync the latest changes from the class version of <code class="highlighter-rouge">class-exercises-spring2025</code> to your copy of the repo on GitHub.</li>
</ul>

<p><strong>On your local computer:</strong></p>
<ul>
  <li>Make sure that all of your changes from the last lab are staged and committed.</li>
  <li>Checkout your main branch: <code class="highlighter-rouge">git checkout main</code></li>
  <li>Pull down the latest changes: <code class="highlighter-rouge">git pull</code>
    <ul>
      <li>If you did it correctly, you will notice that a new <code class="highlighter-rouge">lab07</code> folder has been created.</li>
    </ul>
  </li>
  <li>Create a new branch called lab07-b: <code class="highlighter-rouge">git checkout -b lab07-b</code></li>
  <li>Verify that you’re on your new branch: <code class="highlighter-rouge">git branch</code></li>
</ul>

<h2 id="id_install-the-dependencies-run-your-webserver">Install the dependencies, run your webserver</h2>
<p>Once you’ve created your <code class="highlighter-rouge">lab07-b</code> branch, open the <code class="highlighter-rouge">lab07</code> folder in your code editor, and navigate to the <code class="highlighter-rouge">lab07</code> folder on your terminal. We will not be using Docker – just poetry. Please install the dependencies and run your app as follows:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>poetry <span class="nb">install
cd </span>app
poetry run uvicorn server:app <span class="nt">--reload</span>
</code></pre></div></div>

<p><em>Note that if port 8000 is already being used, you can always run your web server on a different port by using the <code class="highlighter-rouge">--port</code> flag:</em></p>

<p><code class="highlighter-rouge">poetry run uvicorn server:app --reload --host 0.0.0.0 --port 8001</code></p>

<p>If you did this correctly you should see some output like this:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>No dependencies to install or update
INFO:     Will watch for changes in these directories: ['/../csci338/spring2025/class-exercises-spring2025/lab07/app']
INFO:     Uvicorn running on http://127.0.0.1:8000 (Press CTRL+C to quit)
INFO:     Started reloader process [27120] using StatReload
INFO:     Started server process [27124]
INFO:     Waiting for application startup.
INFO:     Application startup complete.

</code></pre></div></div>

<p>You are now ready to use your app.</p>

<h3 id="id_test-out-your-app">Test out your app</h3>
<ul>
  <li>In your browser, navigate to <a href="http://127.0.0.1:8000">http://127.0.0.1:8000</a> (or whichever port you’re using)</li>
  <li>Note that it gives you an error, telling you that <code class="highlighter-rouge">place_name</code> is required. This means that the endpoint of your server needs a value for the <code class="highlighter-rouge">place_name</code> argument in order to know which place to get information from. Try your query again with the required data:</li>
  <li><a href="http://127.0.0.1:8000?place_name=Asheville">http://127.0.0.1:8000?place_name=Asheville</a></li>
  <li>Try using different values for the <code class="highlighter-rouge">place_name</code> argument to see what happens.</li>
</ul>

<blockquote class="info">
  <h3 id="id_questions-to-ask-yourself">Questions to ask yourself</h3>
  <ul>
    <li>Where is this data coming from?</li>
    <li>Is there a way to make this interface more user-friendly and engaging?</li>
    <li>How is AsyncIO being used here, and what advantages are there to using it?</li>
  </ul>
</blockquote>

<h2 id="id_introduction-to-mvc">Introduction to MVC</h2>
<p>Lab 7 implements a MVC architecture (Model, View, Controller) architecture using a few different Python libararies including:</p>
<ol>
  <li><a href="https://fastapi.tiangolo.com/">FastAPI</a>,</li>
  <li>AsyncIO, and</li>
  <li><a href="https://jinja.palletsprojects.com/en/stable/templates/">Jinja</a> (a templating engine)</li>
</ol>

<p>MVC is a design pattern that separates an application into three interconnected components:</p>
<ul>
  <li><strong>Model</strong>: Manages the data and logic (e.g., fetching weather data, restaurant data, cat facts, etc.).</li>
  <li><strong>View</strong>: Handles the presentation layer (e.g., HTML templates).</li>
  <li><strong>Controller</strong>: Orchestrates the flow of data between the Model and View (e.g., FastAPI routes).</li>
</ul>

<p>This separation makes the code easier to manage and scale. Let’s walk through the code to understand how these components work together.</p>

<h3 id="id_models---organizing-and-fetching-data">Models - Organizing and Fetching Data</h3>
<p>Start by opening the <code class="highlighter-rouge">models.py</code>. This file handles data fetching. Each function retrieves information from various APIs, by using a helper function that makes asynchronous network requests:</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># async helper function:
</span><span class="k">async</span> <span class="k">def</span> <span class="nf">fetch_data_from_server</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="p">.</span><span class="n">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">response</span><span class="p">.</span><span class="n">json</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="p">()</span>
                <span class="k">return</span> <span class="p">{</span>
                    <span class="s">"message"</span><span class="p">:</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s">"Error decoding JSON data. Here was the response: `</span><span class="si">{</span><span class="n">response</span><span class="si">}</span><span class="s">`"</span>
                    <span class="p">)</span>
                <span class="p">}</span>
</code></pre></div></div>

<p>Let’s break this function down, because it’s at the heart of this app:</p>

<h4 id="id_1-asynchronous-function-definition">1. Asynchronous function definition</h4>
<p><code class="highlighter-rouge">async def fetch_data_from_server(url):</code></p>

<p>An <em>asynchronous function definition</em> (declared with async def) can perform non-blocking I/O operations, like making HTTP requests without blocking the rest of the program.</p>

<h4 id="id_2-aiohttp-client-session">2. Aiohttp Client Session</h4>
<p><code class="highlighter-rouge">async with aiohttp.ClientSession() as session:</code></p>

<ul>
  <li><code class="highlighter-rouge">aiohttp</code> is an asynchronous HTTP client for Python.</li>
  <li><code class="highlighter-rouge">ClientSession()</code> creates a session object that manages and persists settings like headers and cookies across requests.</li>
  <li><code class="highlighter-rouge">async with</code> ensures the session is properly closed after use, even if an error occurs.</li>
</ul>

<h4 id="id_3-sending-a-get-request">3. Sending a GET Request:</h4>

<p><code class="highlighter-rouge">async with session.get(url) as response:</code></p>

<ul>
  <li><code class="highlighter-rouge">session.get(url)</code> sends an asynchronous GET request to the provided url.</li>
  <li><code class="highlighter-rouge">async with</code> ensures the response object is properly closed once the block ends.</li>
</ul>

<h4 id="id_4-handling-the-response">4. Handling the Response:</h4>

<p><code class="highlighter-rouge">return await response.json()</code></p>

<ul>
  <li><code class="highlighter-rouge">await</code> makes the coroutine pause execution here until the JSON is fetched and parsed.</li>
  <li><code class="highlighter-rouge">await response.json()</code> tries to parse the response body as JSON once it has been transmitted.</li>
</ul>

<h4 id="id_5-error-handling">5. Error Handling:</h4>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>except:
    response = await response.text()
    return {
        "message": (
            f"Error decoding JSON data. Here was the response: `{response}`"
        )
    }
</code></pre></div></div>
<p>Network requests often fail for a variety of reasons. If JSON decoding fails (meaning that there’s a problem with the message), the except block handles the error.</p>
<ul>
  <li><code class="highlighter-rouge">await response.text()</code> retrieves the raw response body as a string.</li>
  <li>It then returns a dictionary with an error message and the raw response content, which can help diagnose the issue.</li>
</ul>

<h3 id="id_example-model">Example Model:</h3>
<p>Let’s take a look at the <code class="highlighter-rouge">get_yelp_data</code> function…</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">async</span> <span class="k">def</span> <span class="nf">get_yelp_data</span><span class="p">(</span><span class="n">place</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">ENDPOINT_YELP</span><span class="si">}</span><span class="s">?location=</span><span class="si">{</span><span class="n">place</span><span class="si">}</span><span class="s">&amp;limit=20"</span>
    <span class="k">print</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="n">places</span> <span class="o">=</span> <span class="k">await</span> <span class="n">fetch_data_from_server</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">random</span><span class="p">.</span><span class="n">choice</span><span class="p">(</span><span class="n">places</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">places</span>
</code></pre></div></div>

<p>Using the <code class="highlighter-rouge">fetch_data_from_server</code> helper function, this function’s job is to first query for the first 20 businesses associated with the place that is passed in as an argument, and then it returns one of those businesses at random.</p>

<blockquote class="info">
  <h3 id="id_1-model-task">1. Model Task</h3>
  <ol>
    <li>Add a new function <code class="highlighter-rouge">get_dog_image()</code> that retrieves a random dog image from the “https://dog.ceo/api/breeds/image/random” API.</li>
  </ol>
</blockquote>

<h3 id="id_controller---managing-requests">Controller - Managing Requests</h3>
<p>The <code class="highlighter-rouge">server.py</code> file acts as the controller. It receives HTTP requests, fetches data using model functions, and returns a response.</p>

<h4 id="id_example">Example:</h4>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"/"</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">home</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">place_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span><span class="bp">None</span><span class="p">)):</span>
    <span class="k">if</span> <span class="n">place_name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">"The `place_name` query parameter is required."</span>

    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>
    <span class="c1"># we're making these I/O-bound function invocations asynchronous:
</span>    <span class="n">weather_data</span><span class="p">,</span> <span class="n">yelp_data</span><span class="p">,</span> <span class="n">wikipedia_data</span><span class="p">,</span> <span class="n">cat_fact</span><span class="p">,</span> <span class="n">joke</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">gather</span><span class="p">(</span>
        <span class="n">models</span><span class="p">.</span><span class="n">get_weather</span><span class="p">(</span><span class="n">place_name</span><span class="p">),</span>
        <span class="n">models</span><span class="p">.</span><span class="n">get_yelp_data</span><span class="p">(</span><span class="n">place_name</span><span class="p">),</span>
        <span class="n">models</span><span class="p">.</span><span class="n">get_wikipedia</span><span class="p">(</span><span class="n">place_name</span><span class="p">),</span>
        <span class="n">models</span><span class="p">.</span><span class="n">get_cat_fact</span><span class="p">(),</span>
        <span class="n">models</span><span class="p">.</span><span class="n">get_joke</span><span class="p">(),</span>
    <span class="p">)</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">templates</span><span class="p">.</span><span class="n">TemplateResponse</span><span class="p">(</span>
        <span class="s">"index.html"</span><span class="p">,</span>
        <span class="p">{</span>
            <span class="s">"request"</span><span class="p">:</span> <span class="n">request</span><span class="p">,</span>
            <span class="s">"time_taken"</span><span class="p">:</span> <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s"> seconds"</span><span class="p">,</span>
            <span class="s">"place_name"</span><span class="p">:</span> <span class="n">place_name</span><span class="p">,</span>
            <span class="s">"weather"</span><span class="p">:</span> <span class="n">weather_data</span><span class="p">,</span>
            <span class="s">"cat_fact"</span><span class="p">:</span> <span class="n">cat_fact</span><span class="p">[</span><span class="s">"fact"</span><span class="p">],</span>
            <span class="s">"joke"</span><span class="p">:</span> <span class="n">joke</span><span class="p">,</span>
            <span class="s">"yelp_data"</span><span class="p">:</span> <span class="n">yelp_data</span><span class="p">,</span>
            <span class="s">"wikipedia_data"</span><span class="p">:</span> <span class="n">wikipedia_data</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>
</code></pre></div></div>

<p>This function listens for GET requests on the <code class="highlighter-rouge">/</code> route. The user is required to provide a <code class="highlighter-rouge">place_name</code> argument. The function then invokes multiple model functions asynchronously using the <code class="highlighter-rouge">await asyncio.gather()</code> function. Once all coroutines resolve (after responses are received from the various servers), the data are passed into a templating function (rendered in the view)</p>

<blockquote class="info">
  <h3 id="id_2-controller-task">2. Controller Task</h3>
  <ol>
    <li>Modify both the <code class="highlighter-rouge">/</code> and the <code class="highlighter-rouge">/api</code> endpoints so that data from the <code class="highlighter-rouge">get_dog_image()</code> function is output (name the key <code class="highlighter-rouge">dog_data</code>).</li>
    <li>Visit <code class="highlighter-rouge">http://localhost:8000/api</code> to verify the result.</li>
  </ol>
</blockquote>

<hr />

<h3 id="id_view---displaying-data">View - Displaying Data</h3>
<p>The <code class="highlighter-rouge">index.html</code> file inside the <code class="highlighter-rouge">templates/</code> directory presents data to the user. This template is a combination of “vanilla” HTML and python expressions (surrounded by double curly braces. Note that only keys that were passed into the template are available to the template.</p>

<h4 id="id_example-1">Example:</h4>
<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nt">&lt;p&gt;</span>Cat Fact: <span class="nt">&lt;/p&gt;</span>
</code></pre></div></div>

<blockquote class="info">
  <h3 id="id_3-view-task">3. View Task</h3>
  <ol>
    <li>Add a new <code class="highlighter-rouge">&lt;img src="??????" /&gt;</code> element to display a photo of your dog (stored in the <code class="highlighter-rouge">dog_data</code> key) in <code class="highlighter-rouge">index.html</code>. Use the double curly braces to output the correct value from the data.</li>
  </ol>
</blockquote>

<h2 id="id_extra-tasks">Extra Tasks</h2>
<ul>
  <li>Try displaying the data from Wikipedia in a nicer format using HTML (e.g., if there’s a photo of the city, show it).</li>
  <li>Try displaying the data from Yelp in a nicer format using HTML (e.g., if there’s a photo of the city, show it).</li>
</ul>

<h3 id="id_useful-documentation">Useful documentation</h3>
<ul>
  <li><a href="https://fastapi.tiangolo.com/">FastAPI</a></li>
  <li><a href="https://jinja.palletsprojects.com/en/stable/templates/">Jinja templates</a></li>
</ul>

<h2 id="id_what-to-submit">What to Submit</h2>
<p>Verify that you have completed the three tasks described above:</p>
<ol>
  <li>Model Task</li>
  <li>Controller Task</li>
  <li>View Task</li>
</ol>

<p>When you’re done, commit and push your lab07-b branch to GitHub and make a pull request. Please ensure that the destination (left-hand side) is pointing to the main branch of your repo and the source (right-hand side) is pointing to the lab06 branch of your repo. Then, please paste a link to your PR in the Moodle.</p>



            </article>  
        </main>
        <footer>
            <p>    
                Department of Computer Science, UNC Asheville
            </p>
        </footer>
        
        <script type="text/javascript" src="/spring2025/assets/js/main.js"></script>

<!-- <script>
    //little bit of a hack:
    const scrollLeft = () => {
        //console.log('scrollLeft');
        document.documentElement.scrollLeft = 0;
    };
    setTimeout(scrollLeft, 100);
</script> -->
        
        <script type="text/javascript" src="/spring2025/assets/js/scrollspy.js"></script>
        <script type="text/javascript" src="/spring2025/assets/js/expandable.js"></script>
    </body>
</html>